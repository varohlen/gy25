---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import SubjectView from '../../components/gy25subject.astro';
import { getSubjectChange, loadFetchReport, toSvDate } from '../../utils/changelog';

export async function getStaticPaths() {
  const subjects = await getCollection('gy25-subjects');
  return subjects.map(subject => ({
    params: { subjectCode: subject.data.code.toLowerCase() },
    props: { subject }
  }));
}

const { subject } = Astro.props;
const subjectChange = getSubjectChange('gy25', subject.data.code);
const apiUpdatedDate = toSvDate(subject.data.modifiedDate);
const fetchReport = loadFetchReport();
const syncedDate = toSvDate(fetchReport?.generatedAt);
---

<Layout title={`${subject.data.name} - GY25`}>
  <div class="max-w-4xl mx-auto px-4 mt-8 mb-8">
    <div class="mb-8">
      <a href="/gy25" class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Tillbaka till ämnen
      </a>
    </div>

    <SubjectView subject={subject} />

    {subjectChange && (
      <section class="mt-10 border-t border-gray-200 pt-4 text-sm text-gray-600">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p>
              Senast uppdaterad hos Skolverket: <span class="font-medium text-gray-800">{apiUpdatedDate}</span>
            </p>
            <p class="text-xs mt-1">
              Senast hämtad av gy25.se: <span class="font-medium text-gray-800">{syncedDate}</span>
            </p>
          </div>
          <a href="/andringar/innehall" class="font-medium text-blue-700 hover:text-blue-800">
            Se ändringar
          </a>
        </div>
      </section>
    )}
  </div>
</Layout>
