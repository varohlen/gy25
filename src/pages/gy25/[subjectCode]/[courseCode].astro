---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import CourseView from '../../../components/gy25course.astro';
import { getSubjectChange, loadFetchReport, toSvDate } from '../../../utils/changelog';

interface Course {
  code: string;
  name: string;
  points?: string;
}

interface StaticPath {
  params: {
    subjectCode: string;
    courseCode: string;
  };
  props: {
    subject: CollectionEntry<'gy25-subjects'>;
    course: Course;
  };
}

export async function getStaticPaths(): Promise<StaticPath[]> {
  const subjects = await getCollection('gy25-subjects');
  const paths: StaticPath[] = [];

  subjects.forEach(subject => {
    subject.data.courses?.forEach(course => {
      paths.push({
        params: { 
          subjectCode: subject.data.code.toLowerCase(),
          courseCode: course.code.toLowerCase()
        },
        props: { subject, course }
      });
    });
  });

  return paths;
}

const { subject, course }: StaticPath['props'] = Astro.props;
const subjectChange = getSubjectChange('gy25', subject.data.code);
const upperCourseCode = course.code.toUpperCase();
const isCourseCentralChanged = (subjectChange?.summary?.courseCentralChangedCodes ?? []).includes(upperCourseCode);
const isCourseMetaChanged = (subjectChange?.summary?.courseMetaChangedCodes ?? []).includes(upperCourseCode);
const apiUpdatedDate = toSvDate(subject.data.modifiedDate);
const fetchReport = loadFetchReport();
const syncedDate = toSvDate(fetchReport?.generatedAt);
---

<Layout title={`${course.name} - ${subject.data.name} - GY25`}>
  <div class="max-w-4xl mx-auto px-4 mt-8 mb-8">
    <!-- Navigation -->
    <div class="mb-8 flex justify-between items-center">
      <a 
        href="/gy25/courses"
        class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Tillbaka till kurser
      </a>

      <a 
        href={`/gy25/${subject.data.code.toLowerCase()}`}
        class="text-blue-600 hover:text-blue-800 flex items-center gap-1 text-sm font-medium"
      >
        Till ämnet {subject.data.name}
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <!-- Course View Component -->
    <CourseView 
      course={course}
      subject={subject}
    />

    {subjectChange && (isCourseCentralChanged || isCourseMetaChanged || subjectChange?.summary?.purposeChanged) && (
      <section class="mt-10 border-t border-gray-200 pt-4 text-sm text-gray-600">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p>
              Senast uppdaterad hos Skolverket: <span class="font-medium text-gray-800">{apiUpdatedDate}</span>
            </p>
            <p class="text-xs mt-1">
              Senast hämtad av gy25.se: <span class="font-medium text-gray-800">{syncedDate}</span>
            </p>
          </div>
          <a href="/andringar/innehall" class="font-medium text-blue-700 hover:text-blue-800">
            Se ändringar
          </a>
        </div>
      </section>
    )}
  </div>
</Layout>
